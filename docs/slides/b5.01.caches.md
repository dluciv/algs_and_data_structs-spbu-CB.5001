<span id="slides-title" hidden>Кэширование</span>

# Предмет лекции

- - - - - -

## Что мы обсуждаем

* Применение
  * Что кэшируется?
* Алгоритмы кэширования
  * Стратегии вытеснения (replacement, eviction)
  * Стратегии размещения
  * Спопобы поддержания когерентности
* Реализации кэшей
  * «Боевые»
  * «Исследовательские»

- - - - - -

# Что кэшируется?

- - - - - -

## Оперативные данные

* ЦП — ОЗУ
  * Современная RAM далеко не Random Access
  * Современные ЦП имеют несколько уровней кэша
* Математическая память
  * ОЗУ — «примерно» кэш математической памяти
    * в большинстве реализаций данные из виртуальной памяти в ОЗУ не копируются, а перемещаются

- - - - - -

## Долговременные данные

* Файловая система
  * Многие ОС достаточно агрессивно кэшируют файловую систему. Пример вывода `top`:
```
MiB Mem :  11899,7 total,    521,0 free,   3912,0 used,   7466,7 buff/cache
MiB Swap:  12288,0 total,  12286,7 free,      1,3 used.   7042,6 avail Mem
```

* Сетевые ресурсы
  * Распределённых кэши
  * Распределённые хэш-таблицы для кратковременного хранения

= = = = = =

# Алгоритмы кэширования и свойства кэшей

- - - - - -

## Характеристики кэшей

Собственные свойства

* Очевидно — общий размер и размер записи (объекта)
* Для аппаратных и распределённых
  * Ассоциативность
  * Способ обеспечения когерентности
* Стратегия размещения и вытеснания данных

В зависимости от свойств и порядка доступа

* Hit Ratio и Miss Ratio — доля кэш-попаданий и кэш-промахов (в сумме 1)
* Reuse Distance — количество обращений между обращениями к одному и тому же объекту в кэше

- - - - - -

## Принципы и алгоритмы вытеснения

В тех случаях, когда размер кэша фиксирован (например, кэш ЦП) или определяется однозначно (например, если под кэш ФС память выделяется  «в последнюю очередь»), кэш заполняется полностью, и задача — понять, что именно из кэша вытеснить.

- - - - - -

## Принцип вытеснения Бэлэди

**Прицнип Ласло Белэди** (он же **Принцип ясновидца**) — вытеснить объект, который не понадобится дольше всего

Алгоритмизировать его невозможно

**Литература**

* Belady L. A. [A study of replacement algorithms for a virtual-storage computer](https://scholar.google.com/scholar?cluster=14870503344420591577) // IBM Systems journal. – 1966. – Т. 5. – №. 2. – С. 78-101.
* Belady L. A., Nelson R. A., Shedler G. S.  // Communications of the ACM. – 1969. – Т. 12. – №. 6. – С. 349-353. [An anomaly in space-time characteristics of certain programs running in a paging machine](https://scholar.google.com/scholar?cluster=3822730899899658691)

@pause@

* Ласло Белади, Тамаш Краус. [Сталин](https://www.ozon.ru/context/detail/id/4239152/) [пер. с венгерского] // Издательство политической литературы, 1990

- - - - - -

## Стратегия вытеснения LRU

**Least Recently Used** — стратегия вытеснения, предписывающая вытеснить неиспользуемый дольше всех объект

@pause@

**Аномалия Бэлэди** — увеличение кэша при определённых порядке доступа к данным и стратегии вытеснения [может ухудшить hit rate](https://en.wikipedia.org/wiki/B%C3%A9l%C3%A1dy%27s_anomaly).

= = = = = =

# Реализации

- - - - - -

## Java Soft- и WeakReference

Это не реализация кеширование, но применение вытеснения при сборке мусора

@pause@

Аналогичная функциональность есть у многих других платформ

- - - - - -

= = = = = =

# Вопросы и упражнения